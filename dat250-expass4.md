# EX 4

I have added JPA annotations to the entities in the backend to enable database persistence.
I managed to get all the new tests to pass without making any breaking changes to the existing code and previous tests still pass unaltered.

The main changes were:
- Added JPA annotations to the entity classes (User, Poll, VoteOption, Vote).
- Updated the id fields to be auto-generated primary keys.
- Created relationships between entities using @ManyToOne and @OneToMany annotations.
- Refactored *creator* fields to *createdBy* and *votesOn* for clarity.
- Changed polls list to a set (LinkedHashSet) to avoid duplicates and ensure proper behavior in collections.
- Updated constructors and methods to accommodate the new relationships and ensure proper initialization of collections. Re-added empty contructors which I previously didn't need, but which are now required by the persistence architecture.
 
The biggest challenge was understanding how to properly set up the relationships between entities and ensuring that the database schema was correctly generated. I also had to refactor some of the existing code to work with the new entity relationships, which required careful consideration to avoid breaking existing functionality.
I initially tried a few different approaches to setting up the relationships.
Because of me not fully understanding the MappingExceptions thrown by Hibernate, I spent time making breaking changes to existing code, then I realized that the issue was inconsistent namings in the mappings.

## PollsTest
- [x] testOptions
- [x] testUsers
- [x] testVotes

### testOptions
The test uses in-memory H2 database (jdbc:h2:mem:), and I don't know how to attach a debugger to the test JVM.
So I added the following code snippet to the build.gradle.kts file to dump the generated DDLs to files in the build directory.

In the build.gradle.kts
```
//tasks.test { // Dumps generated DDLs for testing
//	systemProperty("jakarta.persistence.schema-generation.scripts.action", "drop-and-create")
//	systemProperty("jakarta.persistence.schema-generation.scripts.create-target", "${project.buildDir}/schema-create.sql")
//	systemProperty("jakarta.persistence.schema-generation.scripts.drop-target", "${project.buildDir}/schema-drop.sql")
//}
``` 
SQL scripts generated by Hibernate and used to create the schema in the test:
- [schema-create.sql](backend/build/schema-create.sql)
- [schema-drop.sql](backend/build/schema-drop.sql)


I also enabled the following properties in the PersistenceConfiguration                 
- .property("hibernate.show_sql", "true")
- .property("hibernate.format_sql", "true")

This allowed me to see the actual SQL statements being executed in the test output, which helped me identify issues with the schema and queries.
Example output from testOptions:
```
Hibernate: 
    drop table if exists Poll cascade 
Hibernate: 
    drop table if exists users cascade 
Hibernate: 
    drop table if exists Vote cascade 
Hibernate: 
    drop table if exists VoteOption cascade 
Hibernate: 
    create table Poll (
        createdBy_id bigint,
        id bigint generated by default as identity,
        publishedAt timestamp(6) with time zone,
        validUntil timestamp(6) with time zone,
        question varchar(255),
        primary key (id)
    )
Hibernate: 
    create table users (
        id bigint generated by default as identity,
        email varchar(255),
        username varchar(255),
        primary key (id)
    )
Hibernate: 
    create table Vote (
        id bigint generated by default as identity,
        publishedAt timestamp(6) with time zone,
        user_id bigint,
        votesOn_id bigint,
        primary key (id)
    )
Hibernate: 
    create table VoteOption (
        presentationOrder integer,
        id bigint generated by default as identity,
        poll_id bigint,
        caption varchar(255),
        primary key (id)
    )
Hibernate: 
    alter table if exists Poll 
       add constraint FKdkmoyqj1q082eply7x3x5rj4u 
       foreign key (createdBy_id) 
       references users
Hibernate: 
    alter table if exists Vote 
       add constraint FKokmd21jvr58kf9tkj6esuovna 
       foreign key (user_id) 
       references users
Hibernate: 
    alter table if exists Vote 
       add constraint FKk63v32ombu38t8rp6ysych65i 
       foreign key (votesOn_id) 
       references VoteOption
Hibernate: 
    alter table if exists VoteOption 
       add constraint FK5ak8cifar7gjf4gtkxh5fi68h 
       foreign key (poll_id) 
       references Poll
Hibernate: 
    insert 
    into
        users
        (email, username, id) 
    values
        (?, ?, default)

...
```